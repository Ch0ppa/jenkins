pipeline {
    agent {
        label 'windows-shared'
    }
    options {
    	skipDefaultCheckout()
    }
    environment {
        PROJECT_SOLUTION_NAME = 'aspnet-get-started.sln'
    }
	stages {
	stage('Checkout') {
            steps {
                bat "git clone https://github.com/Ch0ppa/jenkins.git ${BUILD_NUMBER}"
                }}
	stage('checkDir') {
            steps {
                bat "dir ${WORKSPACE}\\${BUILD_NUMBER}" 
                }}	
        stage('Building the project') {
            steps {
                bat "\"${tool 'MSBuild_VS2019community'}\\msbuild.exe\" ${WORKSPACE}\\${BUILD_NUMBER}\\${PROJECT_SOLUTION_NAME} -r -m -v:q -t:rebuild /p:RestorePackagesConfig=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DeployOnBuild=true /p:PackageLocation=${WORKSPACE}\\${BUILD_NUMBER}.zip"
                }}
	stage('Archive') {
            steps {
                archiveArtifacts artifacts: "${BUILD_NUMBER}.zip", followSymlinks: false
                }}	
	stage('TransferToS3') {
            steps {
                powershell "Invoke-Expression [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12"
		powershell "Invoke-WebRequest -Uri "https://awscli.amazonaws.com/AWSCLIV2.msi" -Outfile C:\AWSCLIV2.msi"
		powershell "$arguments = "/i `"C:\AWSCLIV2.msi`" /quiet""
		powershell "Start-Process msiexec.exe -ArgumentList $arguments -Wait"
		powershell "$env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine")"
		powershell "aws --version""
            	}}
}
}
